# 日本語リスニング・発音練習アプリ 設計書

## 1. プロジェクト概要

### 1.1 目的
日本語超初級者（N5以下）向けに、スマートフォンで隙間時間（15〜20分）にできるリスニング・発音練習アプリを提供する。

### 1.2 対象ユーザー
- 日本語超初級者（N5以下）
- リスニングがままならず、授業についていけないレベル
- 日本に来たばかりの留学生

### 1.3 設計方針
| 方針 | 理由 |
|------|------|
| **採点しない** | できないことが数値化されるとモチベーションが下がる |
| **アドバイス型** | 「伝わった」を前提に、改善点を具体的に伝える |
| **短時間で完結** | 1回15〜20分、隙間時間に取り組める |
| **母語サポート** | 超初級者には母語での説明が効果的 |

### 1.4 開発フェーズ
| フェーズ | 内容 | 優先度 |
|---------|------|--------|
| **Phase 1 (MVP)** | スマホで1回の練習が完結できる | **今回実装** |
| Phase 2 | 学習履歴・進捗管理、DB連携 | 後日 |
| Phase 3 | 複数言語対応、教員向けダッシュボード | 将来 |

---

## 2. システム構成

### 2.1 技術スタック

#### フロントエンド
| 技術 | 選定理由 |
|------|----------|
| **Next.js 14 (App Router)** | SSR/SSG対応、参照プロジェクトと同一 |
| **React 18** | コンポーネント指向、hooks活用 |
| **TailwindCSS** | 迅速なUI開発、レスポンシブ対応 |
| **TypeScript** | 型安全性、開発効率向上 |

#### バックエンド/API
| 技術 | 用途 | Phase |
|------|------|-------|
| **Next.js API Routes** | バックエンド処理 | Phase 1 |
| **Gemini API** | 音声認識（文字起こし）＋AIアドバイス生成 | Phase 1 |
| **Supabase** | DB、認証、ストレージ | Phase 2 |

> **Gemini API採用理由**:
> - フリーティア（1日1,000リクエスト）でMVP開発・テスト可能
> - 音声認識とAIアドバイス生成を1つのAPIで統合できる
> - コスト効率が良い（約$0.003〜0.005/分）
> - 将来的にKotoba-Whisper（日本語特化）への切り替えも検討可能

### 2.2 システム構成図 (Phase 1)

```
┌──────────────────────────────────────────────────────────────────┐
│                        ユーザー（スマートフォン）                    │
└────────────────────────────────┬─────────────────────────────────┘
                                 │
                    ┌────────────▼────────────┐
                    │     Next.js Frontend    │
                    │   (PWA対応・レスポンシブ)  │
                    └────────────┬────────────┘
                                 │
              ┌──────────────────┼──────────────────┐
              │                  │                  │
     ┌────────▼──────┐  ┌───────▼───────┐  ┌──────▼──────┐
     │ 音声素材(静的) │  │ API Routes    │  │ localStorage │
     │ /public/audio │  │ /api/*        │  │ (進捗保存)   │
     └───────────────┘  └───────┬───────┘  └─────────────┘
                                │
                 ┌──────────────┴──────────────┐
                 │                             │
        ┌────────▼────────┐         ┌─────────▼─────────┐
        │  Whisper API    │         │  Claude/GPT API   │
        │  (音声→テキスト) │         │  (アドバイス生成)  │
        └─────────────────┘         └───────────────────┘
```

---

## 3. 5ステップ学習フロー

### 3.1 全体フロー

```
┌─────────────────────────────────────────────────────────────┐
│ Step 1: 音声を聞く（約1〜2分）                               │
│   - 短い音声（15〜30秒）を1回聞く                            │
│   - 今の自分がどこまで聞き取れるか確認                        │
└────────────────────────────┬────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 2: スクリプト・翻訳を見る（約3〜5分）                    │
│   - 日本語スクリプト＋母語翻訳を確認                          │
│   - 知らない単語をチェック                                   │
│   - スクリプトを見ながら音声を再生                            │
└────────────────────────────┬────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 3: 意味がわかった状態で聞く（約2〜3分）                  │
│   - スクリプトを見ないで聞く                                  │
│   - 2〜3回繰り返す                                           │
└────────────────────────────┬────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 4: 声に出す（約4〜6分）                                  │
│   - オーバーラッピング（音声と同時にスクリプトを見ながら）     │
│   - リピーティング（一文ずつ止めて真似する）                   │
└────────────────────────────┬────────────────────────────────┘
                             ▼
┌─────────────────────────────────────────────────────────────┐
│ Step 5: 録音してAIアドバイス（約3〜5分）                      │
│   - 自分の発音を録音                                         │
│   - AIが聞き取った結果を表示                                  │
│   - 自己チェック（選択式）                                   │
│   - AIからアドバイスをもらう                                  │
│   - （任意）お手本と聞き比べ                                  │
└─────────────────────────────────────────────────────────────┘

合計: 約15〜20分
```

---

## 4. 画面設計

### 4.1 画面一覧

| 画面名 | パス | 説明 |
|--------|------|------|
| ホーム | `/` | 練習開始ボタン、簡単な説明 |
| レッスン一覧 | `/lessons` | 利用可能なレッスン一覧 |
| 練習画面 | `/practice/[lessonId]` | 5ステップ学習のメイン画面 |
| 設定 | `/settings` | 母語選択、音量設定など |

### 4.2 練習画面（/practice/[lessonId]）の詳細

#### ステップインジケーター
```
[1]─[2]─[3]─[4]─[5]
 ●   ○   ○   ○   ○
聞く 理解 再聴 発音 録音
```

#### Step 1: 音声を聞く
```
┌─────────────────────────────────────────┐
│  Step 1: まず、聞いてみましょう          │
├─────────────────────────────────────────┤
│                                         │
│         [▶ 再生ボタン (大)]              │
│                                         │
│  "何が聞き取れたか、メモしてみてください"  │
│                                         │
│  ┌───────────────────────────────────┐  │
│  │ メモ欄（任意）                     │  │
│  └───────────────────────────────────┘  │
│                                         │
│          [次へ →]                       │
└─────────────────────────────────────────┘
```

#### Step 2: スクリプト・翻訳を見る
```
┌─────────────────────────────────────────┐
│  Step 2: 意味を確認しましょう            │
├─────────────────────────────────────────┤
│                                         │
│  📝 日本語スクリプト                     │
│  ┌───────────────────────────────────┐  │
│  │ きのう、ともだちと えいがを         │  │
│  │ みました。                         │  │
│  │ とても おもしろかったです。          │  │
│  └───────────────────────────────────┘  │
│                                         │
│  🌏 翻訳（ベトナム語）                   │
│  ┌───────────────────────────────────┐  │
│  │ Hôm qua, tôi đã xem phim với       │  │
│  │ bạn. Rất thú vị.                   │  │
│  └───────────────────────────────────┘  │
│                                         │
│  💡 発音ポイント                        │
│  ・「えいが」の「え」→ 口を横に広げる    │
│  ・「ともだち」→ はっきりと4拍で         │
│                                         │
│  [▶ スクリプトを見ながら聞く]            │
│                                         │
│  [← 戻る]     [次へ →]                  │
└─────────────────────────────────────────┘
```

#### Step 3: 意味がわかった状態で聞く
```
┌─────────────────────────────────────────┐
│  Step 3: 意味を思い出しながら聞きましょう  │
├─────────────────────────────────────────┤
│                                         │
│         [▶ 再生ボタン (大)]              │
│                                         │
│        再生回数: 2 / 3                   │
│                                         │
│  "スクリプトを見ないで聞いてみてください"  │
│                                         │
│  [← 戻る]     [次へ →]                  │
└─────────────────────────────────────────┘
```

#### Step 4: 声に出す
```
┌─────────────────────────────────────────┐
│  Step 4: 声に出してみましょう            │
├─────────────────────────────────────────┤
│                                         │
│  ◉ オーバーラッピング（おすすめ）        │
│    音声と同時に読む                      │
│                                         │
│  ○ リピーティング                        │
│    一文ずつ止めて真似する                │
│                                         │
│  📝 スクリプト                           │
│  ┌───────────────────────────────────┐  │
│  │ きのう、ともだちと えいがを         │  │
│  │ みました。                         │  │
│  │ とても おもしろかったです。          │  │
│  └───────────────────────────────────┘  │
│                                         │
│  [▶ 音声を再生して一緒に読む]            │
│                                         │
│  練習回数: 2 / 3                        │
│                                         │
│  [← 戻る]     [次へ →]                  │
└─────────────────────────────────────────┘
```

#### Step 5: 録音してAIアドバイス
```
┌─────────────────────────────────────────┐
│  Step 5: 録音してAIに聞いてもらいましょう │
├─────────────────────────────────────────┤
│                                         │
│  📝 お手本                               │
│  ┌───────────────────────────────────┐  │
│  │ きのう、ともだちと えいがを         │  │
│  │ みました。とても おもしろかったです。 │  │
│  └───────────────────────────────────┘  │
│                                         │
│              ⏺ 00:00                    │
│          [🎤 録音開始]                   │
│                                         │
│  ─────────────────────────────────────  │
│                                         │
│  🤖 AIが聞き取った結果                   │
│  ┌───────────────────────────────────┐  │
│  │ きのう、ともだちと えーがお         │  │
│  │ みました。とても おもしろかったです。 │  │
│  └───────────────────────────────────┘  │
│                                         │
│  📋 自分の発音、どうでしたか？           │
│  ○ お手本と同じように言えた              │
│  ○ だいたい言えたけど、少し違った        │
│  ● 難しかった                           │
│  ○ わからない                           │
│                                         │
│  ─────────────────────────────────────  │
│                                         │
│  💬 AIからのアドバイス                   │
│  ┌───────────────────────────────────┐  │
│  │ 「きのう、ともだちと えいがを       │  │
│  │ みました」ちゃんと伝わりましたよ！   │  │
│  │                                    │  │
│  │ 👍 良かったところ                   │  │
│  │ ・「ともだち」の発音、とてもきれいです │  │
│  │ ・文のリズムが自然でした             │  │
│  │                                    │  │
│  │ 💡 もっと良くなるヒント              │  │
│  │ ・「えいが」の「え」を、もう少し     │  │
│  │   口を横に開いて発音してみてください  │  │
│  │                                    │  │
│  │ この調子で続けていきましょう！        │  │
│  └───────────────────────────────────┘  │
│                                         │
│  🎧 聞き比べ                            │
│  [▶ お手本] [▶ 自分の録音] [▶ 交互に聞く]│
│                                         │
│  [← 戻る]     [練習完了 ✓]              │
└─────────────────────────────────────────┘
```

---

## 5. データ構造

### 5.1 音声素材データ（Phase 1: JSONファイル）

```typescript
// /src/data/lessons.ts

export interface Lesson {
  id: string;
  title: string;
  level: 'N5' | 'N4';
  category: '挨拶' | '日常' | '買い物' | '食事';
  audioUrl: string;           // /public/audio/lesson-001.mp3
  script: {
    japanese: string;         // 日本語（ひらがな・ふりがな付き）
    japanesePlain: string;    // 日本語（プレーンテキスト、音声認識比較用）
  };
  translations: {
    en: string;               // 英語
    vi: string;               // ベトナム語
    zh: string;               // 中国語
  };
  pronunciationTips: {
    ja: string[];             // 日本語でのヒント
    en: string[];             // 英語でのヒント
    vi: string[];             // ベトナム語でのヒント
    zh: string[];             // 中国語でのヒント
  };
  duration: number;           // 秒数
}

// サンプルデータ
export const lessons: Lesson[] = [
  {
    id: 'lesson-001',
    title: '映画を見ました',
    level: 'N5',
    category: '日常',
    audioUrl: '/audio/lesson-001.mp3',
    script: {
      japanese: 'きのう、ともだちと えいがを みました。とても おもしろかったです。',
      japanesePlain: 'きのうともだちとえいがをみましたとてもおもしろかったです',
    },
    translations: {
      en: 'Yesterday, I watched a movie with my friend. It was very interesting.',
      vi: 'Hôm qua, tôi đã xem phim với bạn. Rất thú vị.',
      zh: '昨天我和朋友看了电影。非常有趣。',
    },
    pronunciationTips: {
      ja: [
        '「えいが」の「え」→ 口を横に広げる',
        '「ともだち」→ はっきりと4拍で',
        '「おもしろかった」→ 「しろ」を強調しない',
      ],
      en: [
        '"eiga" - open your mouth wide for "e"',
        '"tomodachi" - pronounce clearly in 4 beats',
      ],
      vi: [
        '"eiga" - mở miệng rộng khi phát âm "e"',
        '"tomodachi" - phát âm rõ ràng 4 nhịp',
      ],
      zh: [
        '"eiga"的"e" - 嘴巴横向张开',
        '"tomodachi" - 清晰地发4拍',
      ],
    },
    duration: 8,
  },
  // ... more lessons
];
```

### 5.2 学習進捗データ（Phase 1: localStorage）

```typescript
// /src/types/progress.ts

export interface LessonProgress {
  lessonId: string;
  completedAt?: string;        // ISO8601
  step1Completed: boolean;
  step2Completed: boolean;
  step3Completed: boolean;
  step3PlayCount: number;
  step4Completed: boolean;
  step4PracticeCount: number;
  step5Completed: boolean;
  lastRecordingUrl?: string;   // Blob URL（セッション中のみ）
  selfEvaluation?: 'same' | 'close' | 'difficult' | 'unknown';
}

export interface UserProgress {
  lessons: Record<string, LessonProgress>;
  preferredLanguage: 'ja' | 'en' | 'vi' | 'zh';
  lastPracticedAt?: string;
}
```

---

## 6. API設計

### 6.1 音声認識＋アドバイス統合API（Gemini）

```typescript
// POST /api/analyze-speech
// Request（FormData）
{
  audio: Blob;                // webm/mp3 形式
  originalText: string;       // お手本テキスト
  selfEvaluation: 'same' | 'close' | 'difficult' | 'unknown';
  userLanguage: 'ja' | 'en' | 'vi' | 'zh';
}

// Response
{
  transcription: string;      // 音声認識結果
  feedback: {
    message: string;          // 全体メッセージ（伝わった！）
    goodPoints: string[];     // 良かった点（1〜2個）
    improvementTip: string;   // 改善ヒント（1個のみ）
    encouragement: string;    // 励まし
  }
}
```

### 6.2 AIアドバイスAPI（テキストのみ）

```typescript
// POST /api/feedback
// Request
{
  originalText: string;       // お手本テキスト
  transcribedText: string;    // 学習者の発音（認識結果）
  selfEvaluation: 'same' | 'close' | 'difficult' | 'unknown';
  userLanguage: 'ja' | 'en' | 'vi' | 'zh';
}

// Response
{
  message: string;            // 全体メッセージ（伝わった！）
  goodPoints: string[];       // 良かった点（1〜2個）
  improvementTip: string;     // 改善ヒント（1個のみ）
  encouragement: string;      // 励まし
}
```

### 6.3 AIプロンプト設計

```
あなたは日本語学習をサポートする優しい先生です。
学生の発音をお手本と比較して、アドバイスしてください。

ルール：
- 最初に「伝わった」ことを認める（重要）
- 良かった点を1〜2個見つける
- 改善点は1個だけ、具体的に伝える
- 点数やスコアは絶対につけない
- 励ましの言葉で終わる
- やさしい日本語で書く（N5レベル）
- ユーザーの母語が{userLanguage}なので、必要に応じて補足を入れる

入力情報：
- お手本テキスト: {originalText}
- 学生の発音（音声認識結果）: {transcribedText}
- 学生の自己評価: {selfEvaluation}

出力フォーマット（JSON）:
{
  "message": "伝わりました！",
  "goodPoints": ["良かった点1", "良かった点2"],
  "improvementTip": "改善ヒント1個",
  "encouragement": "励ましの言葉"
}
```

---

## 7. コンポーネント設計

### 7.1 コンポーネント一覧

```
src/
├── app/
│   ├── page.tsx                    # ホーム画面
│   ├── lessons/
│   │   └── page.tsx                # レッスン一覧
│   ├── practice/
│   │   └── [lessonId]/
│   │       └── page.tsx            # 練習画面（メイン）
│   ├── settings/
│   │   └── page.tsx                # 設定画面
│   └── api/
│       ├── transcribe/
│       │   └── route.ts            # 音声認識API
│       └── feedback/
│           └── route.ts            # AIアドバイスAPI
├── components/
│   ├── layout/
│   │   ├── Header.tsx              # ヘッダー
│   │   └── Footer.tsx              # フッター
│   ├── practice/
│   │   ├── StepIndicator.tsx       # ステップインジケーター
│   │   ├── Step1Listen.tsx         # Step 1: 聞く
│   │   ├── Step2Understand.tsx     # Step 2: 理解
│   │   ├── Step3Relisten.tsx       # Step 3: 再聴
│   │   ├── Step4Speak.tsx          # Step 4: 発音
│   │   └── Step5Record.tsx         # Step 5: 録音・AI
│   ├── audio/
│   │   ├── AudioPlayer.tsx         # 音声プレーヤー
│   │   ├── AudioRecorder.tsx       # 録音機能
│   │   └── AudioCompare.tsx        # 聞き比べ機能
│   ├── feedback/
│   │   ├── SelfEvaluation.tsx      # 自己評価選択
│   │   └── AIFeedback.tsx          # AIアドバイス表示
│   └── common/
│       ├── Button.tsx              # ボタン
│       ├── Card.tsx                # カード
│       └── Modal.tsx               # モーダル
├── hooks/
│   ├── useAudioPlayer.ts           # 音声再生
│   ├── useAudioRecorder.ts         # 音声録音
│   ├── useLessonProgress.ts        # 進捗管理
│   └── useLocalStorage.ts          # localStorage
├── lib/
│   ├── api/
│   │   ├── transcribe.ts           # Whisper API呼び出し
│   │   └── feedback.ts             # Claude/GPT API呼び出し
│   └── utils/
│       ├── audio.ts                # 音声関連ユーティリティ
│       └── text.ts                 # テキスト比較
├── data/
│   └── lessons.ts                  # レッスンデータ
└── types/
    ├── lesson.ts                   # レッスン型定義
    └── progress.ts                 # 進捗型定義
```

### 7.2 主要コンポーネントの責務

| コンポーネント | 責務 |
|---------------|------|
| `AudioPlayer` | 音声再生、再生速度調整、再生回数カウント |
| `AudioRecorder` | 録音開始/停止、波形表示、録音データ管理 |
| `StepIndicator` | 現在のステップ表示、進捗可視化 |
| `SelfEvaluation` | 4択の自己評価UI、選択状態管理 |
| `AIFeedback` | AIアドバイスの表示、ローディング状態 |

---

## 8. 実装優先順位（Phase 1）

### 8.1 Sprint 1（基盤構築）
1. プロジェクトセットアップ（Next.js + TailwindCSS + TypeScript）
2. 音声素材データ構造定義・サンプルデータ作成
3. 共通コンポーネント（Button, Card）
4. ホーム画面・レッスン一覧画面

### 8.2 Sprint 2（音声機能）
1. AudioPlayerコンポーネント
2. AudioRecorderコンポーネント（参照プロジェクトのuseAudioRecorder活用）
3. Step 1〜4 の画面実装
4. 進捗管理（localStorage）

### 8.3 Sprint 3（AI連携）
1. Whisper API連携
2. Claude/GPT API連携
3. Step 5 の画面実装
4. 聞き比べ機能

### 8.4 Sprint 4（仕上げ）
1. レスポンシブ対応の最終調整
2. PWA対応（オフライン再生）
3. パフォーマンス最適化
4. テスト・バグ修正

---

## 9. 参照プロジェクトからの流用

### 9.1 流用するコンポーネント・コード

| 対象 | 参照プロジェクトのファイル | 変更点 |
|------|--------------------------|--------|
| 音声録音Hook | `src/hooks/useAudioRecorder.ts` | ほぼそのまま利用 |
| 音声録音UI | `src/components/AudioRecorder/Recorder.tsx` | デザイン調整 |
| レイアウト構造 | `src/app/layout.tsx` | 認証関連を削除 |

### 9.2 参照プロジェクトとの違い

| 項目 | 参照プロジェクト | 本プロジェクト |
|------|-----------------|---------------|
| 対象者 | N3-N2レベル | N5以下（超初級） |
| フィードバック | スコア型（点数あり） | アドバイス型（点数なし） |
| 認証 | Supabase Auth | なし（Phase 1） |
| データ保存 | Supabase DB | localStorage |
| 音声認識 | Google Speech-to-Text | Whisper API |
| AI | Gemini API | Claude/GPT API |

---

## 10. 今後の拡張計画（Phase 2以降）

### Phase 2: ユーザー管理・データ永続化
- Supabase認証導入
- 学習履歴のDB保存
- 進捗ダッシュボード

### Phase 3: 機能拡張
- 複数言語対応（ネパール語、インドネシア語など）
- 教員向けダッシュボード
- 音声素材の管理画面（教員用）
- 授業との連携機能

---

## 付録

### A. 音声素材の仕様

| 項目 | 仕様 |
|------|------|
| 長さ | 15〜30秒 |
| 形式 | MP3（128kbps以上） |
| レベル | N5〜N4の語彙・文法 |
| 発話速度 | ゆっくり、はっきり |
| 内容 | 1〜3文程度 |

### B. 対応言語（Phase 1）

| 言語 | コード | 優先度 |
|------|--------|--------|
| 日本語 | ja | 必須 |
| 英語 | en | 必須 |
| ベトナム語 | vi | 高 |
| 中国語（簡体字） | zh | 高 |
